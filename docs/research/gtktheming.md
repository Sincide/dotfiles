# Dynamic GTK Theming with Matugen on Hyprland

**Material You color generation creates cohesive desktop themes that automatically adapt to your wallpaper choices.** This comprehensive implementation creates a fully automated system where changing wallpapers instantly updates all GTK applications with matching color schemes derived from the image. The system combines custom GTK theme creation, matugen's powerful color generation, and Hyprland's wayland compositor capabilities to deliver seamless dynamic theming across your entire desktop environment.

Traditional static themes limit visual consistency when wallpapers change, but this workflow uses Material Design 3 color science to extract optimal color palettes from any image and apply them system-wide. The template-based approach ensures themes remain easily customizable while automation handles the complexity of coordinating color changes across GTK3, GTK4, and other desktop components.

## Custom GTK theme architecture and CSS foundation

Creating effective dynamic themes requires understanding GTK's CSS-based theming system and establishing a solid foundation for color customization. **GTK3 and GTK4 use CSS stylesheets with specific node hierarchies and custom properties that differ significantly from web CSS.**

### Essential theme file structure

GTK themes follow a standardized directory structure that enables proper theme recognition and application across the desktop environment:

```
MyDynamicTheme/
├── index.theme                 # Theme metadata and inheritance
├── gtk-3.0/
│   ├── gtk.css                # Main GTK3 stylesheet  
│   ├── gtk-dark.css           # Dark variant (optional)
│   ├── colors.css             # Color variables (matugen target)
│   └── assets/                # Theme images and icons
├── gtk-4.0/
│   ├── gtk.css                # Main GTK4 stylesheet
│   ├── colors.css             # Color variables (matugen target)
│   └── assets/                # GTK4-specific assets
└── metacity-1/                # Window manager decorations
    └── metacity-theme-1.xml
```

The **index.theme** file provides essential metadata for theme recognition:

```ini
[Desktop Entry]
Type=X-GNOME-Metatheme
Name=MyDynamicTheme
Comment=Dynamic Material You theme
Encoding=UTF-8

[X-GNOME-Metatheme]
GtkTheme=MyDynamicTheme
MetacityTheme=MyDynamicTheme  
IconTheme=Adwaita
CursorTheme=Adwaita
ButtonLayout=menu:minimize,maximize,close
```

### CSS customization for dynamic theming

GTK CSS supports color variables through `@define-color` declarations, which become the foundation for dynamic color updates. **Create a modular CSS structure that separates color definitions from component styling:**

```css
/* colors.css - Generated by matugen */
@define-color primary_color #6750A4;
@define-color primary_container #EADDFF;
@define-color on_primary #FFFFFF;
@define-color on_primary_container #21005D;
@define-color secondary_color #625B71;
@define-color secondary_container #E8DEF8;
@define-color surface_color #FEF7FF;
@define-color on_surface #1C1B1F;
@define-color background_color #FEF7FF;
@define-color on_background #1C1B1F;
@define-color error_color #BA1A1A;
@define-color outline_color #79747E;

/* Derived colors for states and interactions */
@define-color hover_overlay alpha(@primary_color, 0.08);
@define-color pressed_overlay alpha(@primary_color, 0.12);
@define-color focus_outline alpha(@primary_color, 0.12);
```

The main **gtk.css** imports color definitions and applies them to components:

```css
@import 'colors.css';

/* Button styling with dynamic colors */
button {
    background: @surface_color;
    color: @on_surface_color;
    border: 1px solid @outline_color;
    border-radius: 20px;
    padding: 8px 24px;
    min-height: 40px;
}

button.suggested-action {
    background: @primary_color;
    color: @on_primary;
    border-color: @primary_color;
}

button:hover {
    background: color-mix(in srgb, @surface_color 92%, @primary_color 8%);
}

button.suggested-action:hover {
    background: color-mix(in srgb, @primary_color 92%, white 8%);
}

/* Entry fields */
entry {
    background: @surface_color;
    color: @on_surface_color;
    border: 1px solid @outline_color;
    border-radius: 4px;
    padding: 12px 16px;
}

entry:focus {
    border-color: @primary_color;
    outline: 2px solid @focus_outline;
    outline-offset: -1px;
}

/* Header bar */
headerbar {
    background: @surface_color;
    color: @on_surface_color;
    border-bottom: 1px solid @outline_color;
    min-height: 48px;
}

headerbar button {
    background: transparent;
    border: none;
    margin: 4px;
}
```

### GTK4-specific considerations

**GTK4 introduces enhanced color functions and simplified widget hierarchies** that require updated CSS approaches:

```css
/* GTK4 color mixing functions */
button:hover {
    background: color-mix(in srgb, @surface_color 92%, @primary_color 8%);
}

/* State layer implementation */
button {
    background: @surface_color;
    position: relative;
}

button::before {
    content: '';
    position: absolute;
    inset: 0;
    background: transparent;
    border-radius: inherit;
    transition: background 200ms cubic-bezier(0.2, 0, 0, 1);
}

button:hover::before {
    background: @hover_overlay;
}

button:active::before {
    background: @pressed_overlay;
}
```

## Matugen integration and color palette generation

**Matugen transforms wallpaper images into comprehensive Material Design 3 color palettes** through advanced color extraction and harmonization algorithms. The tool creates multiple color variants (light, dark, default) and supports extensive template customization for generating themed configuration files.

### Installation and setup on Arch Linux

Install matugen through the AUR for the most current version:

```bash
# Install matugen
yay -S matugen-bin

# Install supporting tools
yay -S swww               # Wayland wallpaper manager
yay -S imagemagick        # Image processing utilities
```

### Color generation workflow

Matugen analyzes wallpaper images using **quantization algorithms to extract dominant colors, then applies Material Design 3 color theory** to create harmonious palettes with proper contrast ratios and accessibility compliance:

```bash
# Basic color generation from wallpaper
matugen image ~/Pictures/wallpapers/mountain.jpg

# Generate with specific scheme preferences
matugen image mountain.jpg --type scheme-content

# Output raw JSON for debugging
matugen image mountain.jpg --json
```

The generated palette includes **over 40 distinct color roles** covering primary, secondary, tertiary, error, neutral, and neutral variant color families, each with appropriate contrast relationships for both light and dark themes.

### Template system configuration

Create a comprehensive matugen configuration that targets GTK theme files:

```toml
# ~/.config/matugen/config.toml
[config]
set_wallpaper = true
reload_apps = true

[config.wallpaper]
command = "swww"
arguments = ["img", "--transition-type", "center", "--transition-duration", "2"]

[templates.gtk3_colors]
input_path = '~/.config/matugen/templates/gtk3-colors.css'
output_path = '~/.config/gtk-3.0/colors.css'

[templates.gtk4_colors]
input_path = '~/.config/matugen/templates/gtk4-colors.css'  
output_path = '~/.config/gtk-4.0/colors.css'

[templates.gtk3_main]
input_path = '~/.config/matugen/templates/gtk3-main.css'
output_path = '~/.themes/MaterialYou/gtk-3.0/gtk.css'

[templates.gtk4_main]
input_path = '~/.config/matugen/templates/gtk4-main.css'
output_path = '~/.themes/MaterialYou/gtk-4.0/gtk.css'
post_hook = 'pkill -SIGUSR1 gtk-update-icon-cache'
```

### Advanced template creation

**Matugen templates use Handlebars syntax with specialized color keywords and filter functions.** Create comprehensive templates that map Material Design 3 colors to GTK variables:

```css
/* ~/.config/matugen/templates/gtk3-colors.css */
/* Material Design 3 Primary Colors */
@define-color primary_color {{colors.primary.default.hex}};
@define-color on_primary_color {{colors.on_primary.default.hex}};
@define-color primary_container_color {{colors.primary_container.default.hex}};
@define-color on_primary_container_color {{colors.on_primary_container.default.hex}};

/* Secondary Colors */  
@define-color secondary_color {{colors.secondary.default.hex}};
@define-color on_secondary_color {{colors.on_secondary.default.hex}};
@define-color secondary_container_color {{colors.secondary_container.default.hex}};
@define-color on_secondary_container_color {{colors.on_secondary_container.default.hex}};

/* Surface and Background */
@define-color surface_color {{colors.surface.default.hex}};
@define-color on_surface_color {{colors.on_surface.default.hex}};
@define-color surface_variant_color {{colors.surface_variant.default.hex}};
@define-color on_surface_variant_color {{colors.on_surface_variant.default.hex}};
@define-color background_color {{colors.background.default.hex}};
@define-color on_background_color {{colors.on_background.default.hex}};

/* Interactive State Colors with Alpha */
@define-color hover_color {{colors.primary.default.hex | set_alpha: 0.08}};
@define-color focus_color {{colors.primary.default.hex | set_alpha: 0.12}};
@define-color pressed_color {{colors.primary.default.hex | set_alpha: 0.16}};
@define-color selected_color {{colors.primary_container.default.hex}};
@define-color disabled_color {{colors.on_surface.default.hex | set_alpha: 0.38}};

/* Error and Warning States */
@define-color error_color {{colors.error.default.hex}};
@define-color on_error_color {{colors.on_error.default.hex}};
@define-color warning_color {{colors.tertiary.default.hex}};
@define-color success_color {{colors.secondary.default.hex}};

/* Border and Outline Colors */
@define-color outline_color {{colors.outline.default.hex}};
@define-color outline_variant_color {{colors.outline_variant.default.hex}};

/* Window and Chrome Colors */
@define-color headerbar_bg_color {{colors.surface_container.default.hex}};
@define-color headerbar_fg_color {{colors.on_surface.default.hex}};
@define-color sidebar_bg_color {{colors.surface_container_low.default.hex}};
@define-color card_bg_color {{colors.surface_container_lowest.default.hex}};
```

Matugen's **filter system enables color manipulation** for creating derived colors:

```css
/* Advanced color derivation with filters */
@define-color button_hover {{colors.primary.default.hex | set_lightness: 0.9}};
@define-color accent_subtle {{colors.primary.default.hex | set_alpha: 0.12}};
@define-color text_secondary {{colors.on_surface.default.hex | set_alpha: 0.7}};
```

## Dynamic theme switching mechanisms

**Effective dynamic theme switching requires coordinating multiple system components** including GSettings, configuration files, and application-specific reload mechanisms. Hyprland's Wayland environment introduces specific requirements for proper theme propagation.

### GSettings-based theme application

**GSettings provides the primary mechanism for system-wide GTK theme changes** on modern Linux systems:

```bash
#!/bin/bash
# Theme switching script with comprehensive coverage

apply_dynamic_theme() {
    local theme_name="MaterialYou"
    
    # Core GTK settings
    gsettings set org.gnome.desktop.interface gtk-theme "$theme_name"
    gsettings set org.gnome.desktop.interface color-scheme "default"
    
    # Icon and cursor coordination  
    gsettings set org.gnome.desktop.interface icon-theme "Adwaita"
    gsettings set org.gnome.desktop.interface cursor-theme "Adwaita"
    
    # Font consistency
    gsettings set org.gnome.desktop.interface font-name "Inter 11"
    gsettings set org.gnome.desktop.interface document-font-name "Inter 11"
    gsettings set org.gnome.desktop.interface monospace-font-name "JetBrains Mono 10"
    
    # Window manager integration
    gsettings set org.gnome.desktop.wm.preferences button-layout "close,minimize,maximize:"
    gsettings set org.gnome.desktop.wm.preferences theme "$theme_name"
}

# Trigger theme reload across running applications
reload_gtk_applications() {
    # Send theme change signals
    killall -SIGUSR1 gtk-update-icon-cache 2>/dev/null || true
    
    # Restart theme-sensitive applications
    pgrep waybar && (pkill waybar && waybar &) || true
    pgrep dunst && systemctl --user restart dunst || true
}
```

### Configuration file synchronization

**Maintain configuration file consistency** for applications that don't use GSettings:

```bash
# Update GTK configuration files directly
update_gtk_configs() {
    # GTK3 settings
    cat > ~/.config/gtk-3.0/settings.ini << EOF
[Settings]
gtk-theme-name=MaterialYou
gtk-icon-theme-name=Adwaita
gtk-font-name=Inter 11
gtk-cursor-theme-name=Adwaita
gtk-cursor-theme-size=0
gtk-toolbar-style=GTK_TOOLBAR_BOTH
gtk-toolbar-icon-size=GTK_ICON_SIZE_LARGE_TOOLBAR
gtk-button-images=1
gtk-menu-images=1
gtk-enable-event-sounds=1
gtk-enable-input-feedback-sounds=1
gtk-xft-antialias=1
gtk-xft-hinting=1
gtk-xft-hintstyle=hintfull
gtk-application-prefer-dark-theme=0
EOF

    # GTK4 settings
    cp ~/.config/gtk-3.0/settings.ini ~/.config/gtk-4.0/settings.ini
    
    # Ensure color imports are present
    echo '@import "colors.css";' > ~/.config/gtk-3.0/gtk.css
    echo '@import "colors.css";' > ~/.config/gtk-4.0/gtk.css
}
```

### Automated theme switching triggers

**Implement robust automation that responds to wallpaper changes:**

```bash
#!/bin/bash
# ~/.local/bin/wallpaper-theme-sync

WALLPAPER_DIR="$HOME/Pictures/wallpapers"
MATUGEN_CONFIG="$HOME/.config/matugen/config.toml"
CURRENT_WALLPAPER=""

# Wallpaper selection and theme generation
change_wallpaper_and_theme() {
    local wallpaper_path="$1"
    
    # Validate wallpaper file
    if [[ ! -f "$wallpaper_path" ]]; then
        echo "Error: Wallpaper not found: $wallpaper_path"
        return 1
    fi
    
    # Generate theme from wallpaper
    echo "Generating theme from: $(basename "$wallpaper_path")"
    if ! matugen image "$wallpaper_path" -c "$MATUGEN_CONFIG"; then
        echo "Error: Theme generation failed"
        return 1
    fi
    
    # Apply the generated theme
    apply_dynamic_theme
    update_gtk_configs  
    reload_gtk_applications
    
    # Update current wallpaper tracking
    CURRENT_WALLPAPER="$wallpaper_path"
    echo "$wallpaper_path" > ~/.cache/current-wallpaper
    
    # Send notification
    notify-send "Theme Updated" "Generated from $(basename "$wallpaper_path")" \
                -i "$wallpaper_path" -t 3000
    
    return 0
}

# Random wallpaper selection
random_wallpaper() {
    find "$WALLPAPER_DIR" -type f \( -name "*.jpg" -o -name "*.png" -o -name "*.webp" \) | shuf -n1
}

# Main execution
case "${1:-random}" in
    random)
        wallpaper=$(random_wallpaper)
        change_wallpaper_and_theme "$wallpaper"
        ;;
    current)
        current=$(cat ~/.cache/current-wallpaper 2>/dev/null || echo "")
        if [[ -n "$current" && -f "$current" ]]; then
            change_wallpaper_and_theme "$current"
        else
            echo "No current wallpaper found, selecting random"
            wallpaper=$(random_wallpaper)
            change_wallpaper_and_theme "$wallpaper"
        fi
        ;;
    *)
        change_wallpaper_and_theme "$1"
        ;;
esac
```

## Hyprland-specific implementation considerations

**Hyprland's Wayland compositor requires specific configuration approaches** for proper GTK theme propagation and system-wide application. Understanding Wayland's different architecture compared to X11 ensures consistent theming across all applications.

### Essential Hyprland configuration

**Configure Hyprland to properly support GTK theming through environment variables and startup commands:**

```bash
# ~/.config/hypr/hyprland.conf

# Essential environment variables for GTK theming
env = GDK_BACKEND,wayland,x11,*
env = XDG_CURRENT_DESKTOP,Hyprland
env = XDG_SESSION_TYPE,wayland
env = XDG_SESSION_DESKTOP,Hyprland

# Cursor theming
env = XCURSOR_THEME,Adwaita
env = XCURSOR_SIZE,24

# GTK theme application on startup
exec-once = gsettings set org.gnome.desktop.interface gtk-theme 'MaterialYou'
exec-once = gsettings set org.gnome.desktop.interface icon-theme 'Adwaita'  
exec-once = gsettings set org.gnome.desktop.interface cursor-theme 'Adwaita'
exec-once = gsettings set org.gnome.desktop.interface color-scheme 'default'

# XDG Desktop Portal configuration for proper theme communication
exec-once = dbus-update-activation-environment --systemd WAYLAND_DISPLAY XDG_CURRENT_DESKTOP
exec-once = systemctl --user import-environment WAYLAND_DISPLAY XDG_CURRENT_DESKTOP

# Theme switching keybinds
bind = SUPER, T, exec, ~/.local/bin/wallpaper-theme-sync random
bind = SUPER_SHIFT, T, exec, ~/.local/bin/wallpaper-theme-sync current
```

### XDG Desktop Portal configuration

**Proper portal configuration ensures theme information propagates to all applications** including sandboxed ones:

```ini
# ~/.config/xdg-desktop-portal/hyprland-portals.conf
[preferred]
default=hyprland;gtk
org.freedesktop.impl.portal.FileChooser=gtk
org.freedesktop.impl.portal.Settings=hyprland
```

Install required portal packages:

```bash
# Essential portal packages for Hyprland
yay -S xdg-desktop-portal-hyprland xdg-desktop-portal-gtk
```

### Wayland-specific GTK considerations

**Wayland applications require different theme application mechanisms** compared to X11:

```bash
# Function to ensure theme application in Wayland
apply_wayland_theme() {
    # Primary GSettings application (works for most GTK apps)
    gsettings set org.gnome.desktop.interface gtk-theme 'MaterialYou'
    gsettings set org.gnome.desktop.interface color-scheme 'default'
    
    # Fallback environment variable for stubborn applications
    export GTK_THEME='MaterialYou'
    
    # Update XDG settings through dconf for maximum compatibility
    dconf write /org/gnome/desktop/interface/gtk-theme "'MaterialYou'"
    dconf write /org/gnome/desktop/interface/color-scheme "'default'"
    
    # Restart settings daemon if available
    systemctl --user restart xdg-desktop-portal 2>/dev/null || true
}
```

## Complete automation workflow implementation

**Combine all components into a production-ready automated system** that seamlessly handles wallpaper changes, theme generation, and system-wide application with robust error handling and performance optimization.

### Master automation script

Create a comprehensive automation system that handles the complete workflow:

```bash
#!/bin/bash
# ~/.local/bin/material-theme-manager
# Complete automation system for dynamic GTK theming

set -euo pipefail

# Configuration
readonly WALLPAPER_DIR="$HOME/Pictures/wallpapers"
readonly THEME_NAME="MaterialYou"
readonly MATUGEN_CONFIG="$HOME/.config/matugen/config.toml"
readonly LOG_FILE="$HOME/.cache/theme-manager.log"
readonly PID_FILE="$HOME/.cache/theme-manager.pid"

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"
}

# Error handling
cleanup() {
    rm -f "$PID_FILE"
    exit 0
}
trap cleanup EXIT INT TERM

# Check if already running
if [[ -f "$PID_FILE" ]] && kill -0 "$(cat "$PID_FILE")" 2>/dev/null; then
    log "Theme manager already running (PID: $(cat "$PID_FILE"))"
    exit 1
fi
echo $$ > "$PID_FILE"

# Theme validation
validate_theme() {
    local theme_path="$HOME/.themes/$THEME_NAME"
    
    # Check theme directory structure
    for dir in "gtk-3.0" "gtk-4.0"; do
        if [[ ! -d "$theme_path/$dir" ]]; then
            log "Warning: Missing theme directory: $theme_path/$dir"
            mkdir -p "$theme_path/$dir"
        fi
    done
    
    # Validate CSS files
    for css_file in "$theme_path/gtk-3.0/gtk.css" "$theme_path/gtk-4.0/gtk.css"; do
        if [[ -f "$css_file" ]]; then
            # Basic CSS syntax validation
            if ! grep -q "@define-color\|@import" "$css_file"; then
                log "Warning: CSS file may be malformed: $css_file"
            fi
        fi
    done
}

# Enhanced wallpaper selection with metadata
select_wallpaper() {
    local selection_mode="$1"
    local wallpaper=""
    
    case "$selection_mode" in
        "random")
            wallpaper=$(find "$WALLPAPER_DIR" -type f \
                       \( -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" \
                       -o -name "*.webp" -o -name "*.bmp" \) | shuf -n1)
            ;;
        "current")
            wallpaper=$(cat ~/.cache/current-wallpaper 2>/dev/null || echo "")
            if [[ ! -f "$wallpaper" ]]; then
                log "Current wallpaper not found, selecting random"
                wallpaper=$(select_wallpaper "random")
            fi
            ;;
        *)
            wallpaper="$selection_mode"
            ;;
    esac
    
    if [[ ! -f "$wallpaper" ]]; then
        log "Error: Wallpaper file not accessible: $wallpaper"
        return 1
    fi
    
    echo "$wallpaper"
}

# Color palette generation with error handling
generate_theme() {
    local wallpaper="$1"
    local temp_config=$(mktemp)
    
    # Copy config with temporary modifications if needed
    cp "$MATUGEN_CONFIG" "$temp_config"
    
    log "Generating theme from: $(basename "$wallpaper")"
    
    # Run matugen with comprehensive error handling
    if ! timeout 30 matugen image "$wallpaper" -c "$temp_config" 2>&1 | tee -a "$LOG_FILE"; then
        log "Error: Theme generation failed or timed out"
        rm -f "$temp_config"
        return 1
    fi
    
    rm -f "$temp_config"
    
    # Validate generated files
    if [[ ! -f "$HOME/.config/gtk-3.0/colors.css" ]]; then
        log "Error: GTK3 colors not generated"
        return 1
    fi
    
    return 0
}

# System-wide theme application with verification
apply_system_theme() {
    log "Applying system-wide theme: $THEME_NAME"
    
    # Apply via GSettings (primary method)
    gsettings set org.gnome.desktop.interface gtk-theme "$THEME_NAME" || {
        log "Warning: GSettings theme application failed, trying fallback"
        export GTK_THEME="$THEME_NAME"
    }
    
    # Coordinate related settings
    gsettings set org.gnome.desktop.interface color-scheme "default"
    gsettings set org.gnome.desktop.interface icon-theme "Adwaita"
    gsettings set org.gnome.desktop.interface cursor-theme "Adwaita"
    
    # Update configuration files for non-GSettings applications
    update_config_files
    
    # Restart theme-sensitive services
    restart_themed_services
    
    # Verify theme application
    sleep 2
    verify_theme_application
}

# Configuration file updates
update_config_files() {
    # GTK3 configuration
    cat > ~/.config/gtk-3.0/settings.ini << EOF
[Settings]
gtk-theme-name=$THEME_NAME
gtk-icon-theme-name=Adwaita
gtk-font-name=Inter 11
gtk-cursor-theme-name=Adwaita
gtk-application-prefer-dark-theme=0
gtk-button-images=1
gtk-menu-images=1
gtk-enable-event-sounds=1
gtk-enable-input-feedback-sounds=1
gtk-xft-antialias=1
gtk-xft-hinting=1
gtk-xft-hintstyle=hintfull
EOF

    # GTK4 configuration (copy from GTK3)
    cp ~/.config/gtk-3.0/settings.ini ~/.config/gtk-4.0/settings.ini
    
    # Ensure CSS imports are present
    for version in 3 4; do
        css_file="$HOME/.config/gtk-${version}.0/gtk.css"
        if ! grep -q '@import "colors.css"' "$css_file" 2>/dev/null; then
            echo '@import "colors.css";' > "$css_file"
        fi
    done
}

# Service restart with error handling
restart_themed_services() {
    local services=("waybar" "dunst" "rofi")
    
    for service in "${services[@]}"; do
        if pgrep "$service" >/dev/null; then
            log "Restarting $service"
            case "$service" in
                "waybar")
                    pkill waybar && sleep 1 && waybar &
                    ;;
                "dunst")
                    systemctl --user restart dunst 2>/dev/null || killall dunst
                    ;;
                *)
                    killall "$service" 2>/dev/null || true
                    ;;
            esac
        fi
    done
    
    # Update icon cache
    gtk-update-icon-cache -f ~/.local/share/icons/* 2>/dev/null || true
}

# Theme application verification
verify_theme_application() {
    local current_theme
    current_theme=$(gsettings get org.gnome.desktop.interface gtk-theme | tr -d "'")
    
    if [[ "$current_theme" == "$THEME_NAME" ]]; then
        log "Theme successfully applied: $current_theme"
        return 0
    else
        log "Warning: Theme verification failed. Expected: $THEME_NAME, Got: $current_theme"
        return 1
    fi
}

# Performance monitoring
monitor_performance() {
    local start_time=$(date +%s)
    "$@"
    local end_time=$(date +%s)
    local duration=$((end_time - start_time))
    
    log "Operation completed in ${duration}s"
    
    # Log resource usage
    echo "Memory usage: $(free -h | awk '/^Mem:/ {print $3}')" >> "$LOG_FILE"
}

# Main execution function
main() {
    local action="${1:-random}"
    local wallpaper
    
    log "Starting theme manager: $action"
    
    # Create necessary directories
    mkdir -p "$HOME/.themes/$THEME_NAME"/{gtk-3.0,gtk-4.0,metacity-1}
    mkdir -p "$HOME/.cache"
    
    # Select wallpaper
    if ! wallpaper=$(select_wallpaper "$action"); then
        log "Failed to select wallpaper"
        exit 1
    fi
    
    # Generate and apply theme
    if monitor_performance generate_theme "$wallpaper"; then
        validate_theme
        monitor_performance apply_system_theme
        
        # Update tracking
        echo "$wallpaper" > ~/.cache/current-wallpaper
        date > ~/.cache/last-theme-update
        
        # Send notification
        notify-send "Theme Updated" \
                   "Generated from $(basename "$wallpaper")" \
                   -i "$wallpaper" -t 3000 2>/dev/null || true
        
        log "Theme update completed successfully"
    else
        log "Theme generation failed"
        exit 1
    fi
}

# Help function
show_help() {
    cat << EOF
Material Theme Manager - Dynamic GTK theming with matugen

Usage: $0 [OPTION]

Options:
    random              Select random wallpaper (default)
    current             Regenerate theme from current wallpaper  
    /path/to/image      Use specific wallpaper file
    help               Show this help message

Examples:
    $0                                    # Random wallpaper
    $0 current                           # Current wallpaper
    $0 ~/Pictures/mountain.jpg           # Specific wallpaper
EOF
}

# Command line argument handling
case "${1:-random}" in
    "help"|"-h"|"--help")
        show_help
        exit 0
        ;;
    *)
        main "$@"
        ;;
esac
```

### Systemd automation service

Create systemd services for scheduled and triggered theme updates:

```ini
# ~/.config/systemd/user/material-theme.service
[Unit]
Description=Material Theme Manager
After=graphical-session.target

[Service]
Type=oneshot
Environment=DISPLAY=:0
Environment=WAYLAND_DISPLAY=wayland-0
ExecStart=%h/.local/bin/material-theme-manager random
TimeoutStartSec=60
```

```ini
# ~/.config/systemd/user/material-theme.timer
[Unit]  
Description=Material Theme Auto-Update
Requires=material-theme.service

[Timer]
OnCalendar=*-*-* 08:00:00
OnCalendar=*-*-* 18:00:00
Persistent=true
RandomizedDelaySec=300

[Install]
WantedBy=timers.target
```

Enable the automation:

```bash
# Enable systemd services
systemctl --user daemon-reload
systemctl --user enable --now material-theme.timer

# Manual theme update
systemctl --user start material-theme.service

# Check status
systemctl --user status material-theme.timer
```

## Best practices and optimization strategies

**Implement production-ready patterns for maintainable, performant dynamic theming** that handles edge cases, optimizes resource usage, and provides robust error recovery mechanisms.

### Performance optimization techniques

**Minimize theme switching overhead** through caching, lazy loading, and efficient resource management:

```bash
# Theme caching system
THEME_CACHE_DIR="$HOME/.cache/material-themes"

cache_theme() {
    local wallpaper_hash=$(sha256sum "$1" | cut -d' ' -f1)
    local cache_dir="$THEME_CACHE_DIR/$wallpaper_hash"
    
    if [[ -d "$cache_dir" ]]; then
        log "Using cached theme for $(basename "$1")"
        cp -r "$cache_dir/"* ~/.config/
        return 0
    fi
    
    # Generate new theme
    if generate_theme "$1"; then
        # Cache the generated files
        mkdir -p "$cache_dir"
        cp ~/.config/gtk-3.0/colors.css "$cache_dir/"
        cp ~/.config/gtk-4.0/colors.css "$cache_dir/"
    fi
}

# Resource monitoring and cleanup
cleanup_old_caches() {
    find "$THEME_CACHE_DIR" -type d -mtime +7 -exec rm -rf {} + 2>/dev/null || true
}
```

### Error handling and recovery

**Implement comprehensive error handling with graceful fallbacks:**

```bash
# Fallback theme application
apply_fallback_theme() {
    log "Applying fallback theme due to error"
    
    gsettings set org.gnome.desktop.interface gtk-theme 'Adwaita'
    gsettings set org.gnome.desktop.interface color-scheme 'default'
    
    # Restore default color definitions
    cat > ~/.config/gtk-3.0/colors.css << 'EOF'
@define-color theme_bg_color #ffffff;
@define-color theme_fg_color #2e3436;
@define-color theme_selected_bg_color #4a90d9;
@define-color theme_selected_fg_color #ffffff;
EOF
    
    cp ~/.config/gtk-3.0/colors.css ~/.config/gtk-4.0/colors.css
}

# Health check system
health_check() {
    local issues=0
    
    # Check theme file integrity
    for css_file in ~/.config/gtk-{3,4}.0/colors.css; do
        if [[ ! -f "$css_file" ]] || ! grep -q "@define-color" "$css_file"; then
            log "Health check failed: Invalid CSS file $css_file"
            ((issues++))
        fi
    done
    
    # Check GSettings consistency
    local current_theme=$(gsettings get org.gnome.desktop.interface gtk-theme | tr -d "'")
    if [[ "$current_theme" != "$THEME_NAME" ]]; then
        log "Health check failed: Theme mismatch"
        ((issues++))
    fi
    
    if ((issues > 0)); then
        log "Health check found $issues issues, attempting recovery"
        apply_fallback_theme
        return 1
    fi
    
    return 0
}
```

### Integration with existing desktop components

**Ensure seamless integration with desktop environments and applications:**

```bash
# Desktop environment detection and adaptation
detect_desktop_environment() {
    if [[ "$XDG_CURRENT_DESKTOP" == *"GNOME"* ]]; then
        echo "gnome"
    elif [[ "$XDG_CURRENT_DESKTOP" == *"KDE"* ]]; then
        echo "kde"
    elif pgrep -f "hyprland" >/dev/null; then
        echo "hyprland"
    else
        echo "generic"
    fi
}

# Environment-specific optimizations
apply_environment_optimizations() {
    local desktop=$(detect_desktop_environment)
    
    case "$desktop" in
        "gnome")
            # GNOME-specific optimizations
            gsettings set org.gnome.desktop.interface enable-animations true
            gsettings set org.gnome.desktop.interface enable-hot-corners false
            ;;
        "hyprland")
            # Hyprland-specific configuration
            hyprctl keyword decoration:rounding 12
            hyprctl keyword decoration:blur:enabled true
            ;;
        *)
            log "Applying generic desktop optimizations"
            ;;
    esac
}
```

This comprehensive implementation provides a complete system for dynamic GTK theming with matugen on Hyprland. The solution automatically generates Material Design 3 compliant themes from wallpapers, applies them system-wide through proper Wayland integration, and maintains robust automation with error handling and performance optimization. The modular architecture supports easy customization while ensuring reliable operation across different desktop configurations.